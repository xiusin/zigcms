//! åŸºç¡€è®¾æ–½å±‚å…¥å£æ–‡ä»¶ (Infrastructure Layer)
//!
//! ZigCMS åŸºç¡€è®¾æ–½å±‚æä¾›ä¸å¤–éƒ¨ç³»ç»Ÿäº¤äº’çš„å…·ä½“å®ç°ã€‚
//! è¯¥å±‚å®ç°é¢†åŸŸå±‚å®šä¹‰çš„ä»“å‚¨æ¥å£ï¼Œå¤„ç†æ•°æ®åº“ã€ç¼“å­˜ã€HTTP ç­‰å¤–éƒ¨æœåŠ¡ã€‚
//!
//! ## èŒè´£
//! - æä¾›æ•°æ®åº“ã€ç¼“å­˜ã€HTTP å®¢æˆ·ç«¯ç­‰å¤–éƒ¨æœåŠ¡çš„å®ç°
//! - å®ç°é¢†åŸŸå±‚å®šä¹‰çš„ä»“åº“æ¥å£
//! - å¤„ç†å¤–éƒ¨ç³»ç»Ÿé›†æˆ
//! - ä¸å¤–éƒ¨ç³»ç»Ÿé€šä¿¡çš„é€‚é…å™¨
//!
//! ## æ¨¡å—ç»“æ„
//! - `database`: æ•°æ®åº“è¿æ¥å’Œäº‹åŠ¡ç®¡ç†
//! - `cache`: ç¼“å­˜æœåŠ¡ï¼ˆå†…å­˜ã€Redisï¼‰
//! - `http`: HTTP å®¢æˆ·ç«¯
//! - `messaging`: æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆå¾…å®ç°ï¼‰
//!
//! ## ä½¿ç”¨ç¤ºä¾‹
//! ```zig
//! const infra = @import("infrastructure/mod.zig");
//!
//! // åˆå§‹åŒ–åŸºç¡€è®¾æ–½å±‚
//! const db = try infra.init(allocator, .{});
//! defer infra.deinit();
//!
//! // ä½¿ç”¨æ•°æ®åº“
//! const conn = try infra.database.DatabaseFactory.create(allocator, .SQLite, config);
//! defer conn.close();
//!
//! // ä½¿ç”¨ç¼“å­˜
//! const cache = try infra.cache.CacheFactory.create(allocator, .{});
//! ```
//!
//! ## ä¾èµ–è§„åˆ™
//! - åŸºç¡€è®¾æ–½å±‚ä¾èµ–é¢†åŸŸå±‚ï¼ˆå®ç°ä»“å‚¨æ¥å£ï¼‰
//! - ä¾èµ–å…±äº«å±‚å’Œåº”ç”¨å±‚çš„æœåŠ¡
//! - æ˜¯ä¾èµ–é“¾çš„æœ€å¤–å±‚ï¼Œç›´æ¥ä¸å¤–éƒ¨ç³»ç»Ÿäº¤äº’

const std = @import("std");
const logger = @import("../application/services/logger/logger.zig");
const sql = @import("../application/services/sql/orm.zig");

// ============================================================================
// å…¬å…± API å¯¼å‡º
// ============================================================================

/// æ•°æ®åº“åŸºç¡€è®¾æ–½
///
/// æä¾›æ•°æ®åº“è¿æ¥ç®¡ç†ã€äº‹åŠ¡å¤„ç†ã€è¿æ¥æ± ç­‰åŠŸèƒ½ã€‚
/// æ”¯æŒå¤šç§æ•°æ®åº“é©±åŠ¨ï¼ˆSQLiteã€PostgreSQLã€MySQLï¼‰ã€‚
pub const database = @import("database/mod.zig");

/// ç¼“å­˜åŸºç¡€è®¾æ–½
///
/// æä¾›ç»Ÿä¸€çš„ç¼“å­˜æ¥å£ï¼Œæ”¯æŒå¤šç§åç«¯ï¼ˆå†…å­˜ã€Redisã€Memcachedï¼‰ã€‚
/// åŒ…å« TTL ç®¡ç†ã€ç¼“å­˜æ¸…ç†ç­‰åŠŸèƒ½ã€‚
pub const cache = @import("cache/mod.zig");

/// HTTP å®¢æˆ·ç«¯åŸºç¡€è®¾æ–½
///
/// æä¾› HTTP å®¢æˆ·ç«¯åŠŸèƒ½ï¼Œç”¨äºä¸å¤–éƒ¨ API äº¤äº’ã€‚
/// æ”¯æŒå„ç§ HTTP æ–¹æ³•ã€è¶…æ—¶è®¾ç½®ã€é‡è¯•æœºåˆ¶ã€‚
pub const http = @import("http/mod.zig");

/// æ¶ˆæ¯ç³»ç»ŸåŸºç¡€è®¾æ–½ï¼ˆå¾…å®ç°ï¼‰
///
/// æä¾›æ¶ˆæ¯é˜Ÿåˆ—åŠŸèƒ½ï¼Œç”¨äºå¼‚æ­¥ä»»åŠ¡å¤„ç†å’Œäº‹ä»¶é©±åŠ¨æ¶æ„ã€‚
// pub const messaging = @import("messaging/mod.zig");

// ============================================================================
// å±‚é…ç½®
// ============================================================================

/// åŸºç¡€è®¾æ–½å±‚é…ç½®
///
/// é…ç½®æ•°æ®åº“è¿æ¥ã€ç¼“å­˜æœåŠ¡ã€HTTP å®¢æˆ·ç«¯ç­‰å¤–éƒ¨æœåŠ¡å‚æ•°ã€‚
pub const InfraConfig = struct {
    // æ•°æ®åº“è¿æ¥é…ç½®
    db_host: []const u8 = "localhost",
    db_port: u16 = 5432,
    db_name: []const u8 = "zigcms",
    db_user: []const u8 = "postgres",
    db_password: []const u8 = "password",
    db_pool_size: u32 = 10,

    // ç¼“å­˜é…ç½®
    cache_enabled: bool = true,
    cache_backend: cache.CacheBackend = .Memory,
    cache_host: []const u8 = "localhost",
    cache_port: u16 = 6379,
    cache_password: ?[]const u8 = null,
    cache_ttl: u64 = 3600,

    // HTTP å®¢æˆ·ç«¯é…ç½®
    http_timeout_ms: u32 = 30000,
    http_max_redirects: u32 = 5,
};

// ============================================================================
// ç”Ÿå‘½å‘¨æœŸç®¡ç†
// ============================================================================

/// åˆå§‹åŒ–åŸºç¡€è®¾æ–½å±‚
///
/// åœ¨åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶è°ƒç”¨ï¼Œåˆå§‹åŒ–æ•°æ®åº“è¿æ¥å’Œå…¶ä»–å¤–éƒ¨æœåŠ¡ã€‚
///
/// ## å‚æ•°
/// - `allocator`: å†…å­˜åˆ†é…å™¨
/// - `config`: åŸºç¡€è®¾æ–½å±‚é…ç½®
///
/// ## è¿”å›
/// è¿”å›åˆå§‹åŒ–çš„æ•°æ®åº“å®ä¾‹æŒ‡é’ˆã€‚
///
/// ## é”™è¯¯
/// å¦‚æœæ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œè¿”å›ç›¸åº”çš„é”™è¯¯ã€‚
pub fn init(allocator: std.mem.Allocator, config: InfraConfig) !*sql.Database {
    _ = config; // Currently not used for SQLite

    // åˆå§‹åŒ–æ•°æ®åº“ - ä½¿ç”¨ SQLite
    const db = try allocator.create(sql.Database);
    errdefer allocator.destroy(db);

    db.* = sql.Database.sqlite(allocator, "zigcms.db") catch |e| {
        return e;
    };
    // æ³¨æ„ï¼šä¸éœ€è¦åœ¨è¿™é‡Œè®¾ç½® errdefer db.deinit()
    // å› ä¸ºè°ƒç”¨è€…ï¼ˆroot.zigï¼‰ä¼šè´Ÿè´£åœ¨é”™è¯¯æ—¶æ¸…ç†

    // åˆå§‹åŒ–åŸºç¡€è®¾æ–½ç»„ä»¶
    logger.info("åŸºç¡€è®¾æ–½å±‚åˆå§‹åŒ–å®Œæˆï¼Œä½¿ç”¨ SQLite æ•°æ®åº“", .{});

    return db;
}

/// æ¸…ç†åŸºç¡€è®¾æ–½å±‚
///
/// åœ¨åº”ç”¨ç¨‹åºå…³é—­æ—¶è°ƒç”¨ï¼Œå…³é—­æ•°æ®åº“è¿æ¥å’Œå…¶ä»–å¤–éƒ¨æœåŠ¡ã€‚
///
/// æ³¨æ„ï¼šåŸºç¡€è®¾æ–½å±‚çš„å®é™…æ¸…ç†ç”± root.zig çš„ deinitSystem ç»Ÿä¸€ç®¡ç†ï¼š
/// - æ•°æ®åº“è¿æ¥é€šè¿‡ infrastructure_db å˜é‡æ¸…ç†
/// - ç¼“å­˜è¿æ¥é€šè¿‡ ServiceManager æ¸…ç†
/// - HTTP å®¢æˆ·ç«¯èµ„æºé€šè¿‡å…¶è‡ªèº«çš„ deinit æ–¹æ³•æ¸…ç†
///
/// æ­¤å‡½æ•°ä¿ç•™ç”¨äºç‹¬ç«‹çš„æ¸…ç†åœºæ™¯ï¼Œä¸åº”åœ¨æ­£å¸¸æµç¨‹ä¸­ç›´æ¥è°ƒç”¨ã€‚
pub fn deinit() void {
    std.debug.print("ğŸ‘‹ åŸºç¡€è®¾æ–½å±‚å·²æ¸…ç†\n", .{});
}
