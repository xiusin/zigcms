<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>图库管理power by www.nbnat.com</title>
        <meta name="renderer" content="webkit" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1, maximum-scale=1"
        />
        <link
            rel="stylesheet"
            type="text/css"
            href="https://www.layuicdn.com/layui/css/layui.css"
        />
        <style>
            .layui-upload-img {
                width: 92px;
                height: 92px;
                margin: 0 10px 10px 0;
            }

            #fileManager .layui-card {
                padding: 10px;
            }

            #fileManager .layui-card-body {
                padding-left: 0;
            }

            #fileManager .layui-card-body:nth-child(2) {
                min-height: 300px;
            }

            .selected {
                background-color: lavender;
                border-radius: 6px;
            }

            #fileManager img {
                width: 90px;
                height: 90px;
                border-radius: 5px;
            }
        </style>
    </head>

    <body style="padding: 10px">
        <!-- <button type="button" class="layui-hide" id="test1"></button> -->
        <div class="layui-fluid">
            <div id="fileManager" lay-filter="test"></div>
        </div>
        <fieldset
            class="layui-elem-field layui-field-title"
            style="margin-top: 30px; display: none"
        >
            <legend>弹层选图</legend>
        </fieldset>
        <div class="layui-upload" style="display: none">
            <div style="width: 150px; display: inline-block">
                <div class="layui-upload-listv picview" data-name="pic1">
                    <img class="layui-upload-img" />
                    <p>&nbsp;</p>
                </div>
            </div>
            <div style="width: 150px; display: inline-block">
                <div class="layui-upload-listv picview" data-name="pic2">
                    <img class="layui-upload-img" />
                    <p>&nbsp;</p>
                </div>
            </div>
            <div style="width: 150px; display: inline-block">
                <div class="layui-upload-listv picview" data-name="pic3">
                    <img class="layui-upload-img" />
                    <p>&nbsp;</p>
                </div>
            </div>
        </div>
    </body>
    <script src="https://www.layuicdn.com/layui/layui.js"></script>
    <script>
        layui.extend({ fileManager: "../../fileManager/fileManager" });
        layui.use(["fileManager", "layer", "upload"], function () {
            var fileManager = layui.fileManager,
                $ = layui.$,
                dropdown = layui.dropdown,
                upload = layui.upload,
                layer = layui.layer;
            $("title").html($("title").html() + " version:" + fileManager.v);
            var upIns = upload.render({
                elem: "#test1", //绑定元素
                url: "data.php?action=upload", //上传接口
                field: "file[]",
            });
            fileManager.render({
                elem: "#fileManager",
                method: "post",
                id: "fmTest",
                btn_upload: true,
                btn_create: true,
                btn_delete: true,
                icon_url: "ico/",
                url: "/public/files",
                thumb: {
                    nopic: "upload/null-100x100.jpg",
                    width: 90,
                    height: 90,
                },
                parseData: function (res) {
                    let _res = [];
                    _res.code = 0;
                    _res.data = res.data?.images || [];
                    _res.count = res.data.count || 0;
                    return _res;
                },
                done: function (res, curr, count) {
                    dropdown.render({
                        elem: ".fileManager > li", // 也可绑定到 document，从而重置整个右键
                        trigger: "contextmenu", // contextmenu
                        isAllowSpread: false, // 禁止菜单组展开收缩
                        style: "width: 130px", // 定义宽度，默认自适应
                        data: [
                            {
                                title: "打开",
                                id: "open",
                            },
                            {
                                title: "返回",
                                id: "back",
                            },
                            {
                                title: "删除",
                                id: "delete",
                            },
                        ],
                        ready: function (elemPanel, elem) {
                            $(this.elem)
                                .parent()
                                .find("li")
                                .removeClass("selected");
                            $(this.elem).addClass("selected");
                        },
                        click: function (obj, othis) {
                            if (obj.id === "open") {
                                $(this.elem).click(); // 打开目录
                            } else if (obj.id === "back") {
                                $("#back").click(); // 返回上一级
                            } else if (obj.id === "delete") {
                                let that = this;
                                layer.confirm(
                                    "确定要删除“" +
                                        $(that.elem).text() +
                                        "”吗，此操作会级联删除所有的下级？",
                                    {
                                        btn: ["确定", "关闭"], //按钮
                                    },
                                    function () {
                                        var loadIndex = layer.msg("删除中...", {
                                            icon: 16,
                                            shade: 0.01,
                                        });

                                        $.post(
                                            `/public/delete-file`,
                                            {
                                                path: fileManager.dirRoot[
                                                    fileManager.dirRoot.length -
                                                        1
                                                ]["path"],
                                                obj: $(that.elem).text(),
                                            },
                                            function () {},
                                        );
                                    },
                                );
                            }
                        },
                    });
                },
                page: {
                    limit: 12,
                    layout: [
                        "count",
                        "prev",
                        "page",
                        "next",
                        "limit",
                        "refresh",
                        "skip",
                    ],
                },
                where: {},
            });
            //监听图片选择事件
            fileManager.on("pic(test)", function (obj) {
                if (
                    ["jpg", "jpeg", "gif", "bmp", "png"].includes(obj.data.type)
                ) {
                    layer.photos({
                        photos: {
                            title: obj.data.name,
                            start: 0,
                            data: [
                                {
                                    alt: obj.data.name,
                                    pid: 1,
                                    src: `/${obj.data.path}`,
                                },
                            ],
                        },
                    });
                } else {
                    return;
                }

                //obj.obj 当前对象
                //obj.data 当前图片数据
                var data = obj.data;
                layer.alert(JSON.stringify(data), {
                    title: "当前数据：",
                });
            });
            //监听图片上传事件
            fileManager.on("uploadfile(test)", function (obj) {
                //obj.obj 当前对象
                //obj.path 路径
                //更改上传组件参数
                upIns.config.data = { path: obj.path };
                upIns.config.done = function (res) {
                    fileManager.reload("fmTest");
                };
                var e = document.createEvent("MouseEvents");
                e.initEvent("click", true, true);
                document.getElementById("test1").dispatchEvent(e);
            });
            //监听新建文件夹事件
            fileManager.on("new_dir(test)", function (obj) {
                //obj.obj 当前对象
                //obj.folder 文件夹名称
                //obj.path 路径
                $.post(
                    "/public/folder",
                    { folder: obj.folder, path: obj.path },
                    function (e) {
                        layer.msg(e.msg);
                        if (e.code == 0) {
                            fileManager.reload("fmTest");
                        }
                    },
                );
            });
            //弹层选择
            $(document).on("click", ".picview", function (res) {
                let name = $(this).data("name");
                layui.data("_fm", { key: "_picview_name", value: name });
                layer.open({
                    type: 2,
                    area: ["620px", "600px"],
                    content: ["pop.html", "no"],
                });
            });
            //弹层选择后的回调
            window.callback = function (res) {
                let name = layui.data("_fm")._picview_name;
                console.log(name);
                $(".picview[data-name=" + name + "]")
                    .find("img")
                    .attr("src", res.thumb);
                $(".picview[data-name=" + name + "]")
                    .find("p")
                    .text(res.name);
                layui.data("_fm", null);
            };
        });
    </script>
</html>
