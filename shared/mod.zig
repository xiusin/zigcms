//! 共享层入口文件 (Shared Layer)
//!
//! ZigCMS 共享层提供跨层共享的基础设施，是整个系统的底层支撑。
//! 该层不依赖任何业务层（domain, application, api），确保依赖方向正确。
//!
//! ## 职责
//! - 提供跨层共享的工具函数（字符串处理、JWT、加密等）
//! - 定义通用类型和常量（分页、HTTP 状态码等）
//! - 提供基础原语和辅助功能（全局变量、容器、注册表）
//! - 统一错误处理机制
//!
//! ## 模块结构
//! - `utils`: 工具函数集合
//! - `primitives`: 基础原语（全局变量、依赖注入容器）
//! - `types`: 通用类型定义
//! - `errors`: 统一错误处理
//!
//! ## 使用示例
//! ```zig
//! const shared = @import("shared/mod.zig");
//!
//! // 使用工具函数
//! const result = shared.utils.strings.trim("  hello  ");
//!
//! // 使用类型定义
//! var pagination = shared.types.Pagination{ .page = 1, .page_size = 10 };
//!
//! // 使用错误处理
//! const status = shared.errors.errorToHttpStatus(error.NotFound);
//! ```
//!
//! ## 依赖规则
//! - 共享层不依赖任何业务层
//! - 仅依赖标准库和外部工具库

const std = @import("std");

// ============================================================================
// 公共 API 导出
// ============================================================================

/// 工具函数模块
///
/// 提供字符串处理、JWT 令牌、Redis 客户端、正则表达式等常用工具。
/// 所有工具函数都是无状态的，可以安全地在多线程环境中使用。
pub const utils = @import("utils/mod.zig");

/// 基础原语模块
///
/// 提供全局变量管理、依赖注入容器、服务注册表等基础设施。
/// 这些原语是构建应用程序的基础组件。
pub const primitives = @import("primitives/mod.zig");

/// 通用类型定义模块
///
/// 定义项目中共享的类型，包括分页参数、HTTP 方法、状态码、
/// 结果类型等。这些类型在各层之间传递数据时使用。
pub const types = @import("types/mod.zig");

/// 统一错误处理模块
///
/// 定义应用程序的错误类型层次结构，提供错误到 HTTP 状态码的映射，
/// 以及错误消息的国际化支持。
pub const errors = @import("errors/mod.zig");

/// 配置模块
///
/// 提供配置加载和管理功能，支持从 TOML 文件加载配置，
/// 环境变量覆盖，以及配置验证。
pub const config = @import("config/mod.zig");

// ============================================================================
// 便捷访问（向后兼容）
// ============================================================================

/// 全局变量管理器
///
/// 提供对全局状态的访问，包括数据库连接、配置等。
/// 注意：优先使用依赖注入而非全局变量。
pub const global = primitives.global;

/// 日志记录器
///
/// 提供统一的日志记录接口，支持不同级别的日志输出。
pub const logger = primitives.logger;

// ============================================================================
// 层配置
// ============================================================================

/// 共享层配置
///
/// 用于配置共享层的行为，如日志级别、调试模式等。
pub const SharedConfig = struct {
    /// 日志级别
    log_level: LogLevel = .Info,
    /// 是否启用调试模式
    debug_mode: bool = false,

    /// 日志级别枚举
    pub const LogLevel = enum {
        Debug,
        Info,
        Warn,
        Error,
    };
};

// ============================================================================
// 生命周期管理
// ============================================================================

/// 初始化共享层
///
/// 在应用程序启动时调用，初始化全局模块和各个子模块。
/// 必须在使用任何共享层功能之前调用。
///
/// ## 参数
/// - `allocator`: 内存分配器，用于分配共享层所需的内存
/// - `shared_config`: 共享层配置
///
/// ## 错误
/// 如果初始化失败，返回相应的错误。
pub fn init(allocator: std.mem.Allocator, shared_config: SharedConfig) !void {
    _ = shared_config;
    _ = allocator;

    // 注意：不再在这里调用 global.init()
    // global 模块的初始化已经移到 root.zig 的 initSystem 中统一管理
    // 这样可以避免重复初始化数据库连接和服务管理器
    
    std.debug.print("✅ 共享层初始化完成\n", .{});

    // 初始化各个子模块（这些是无状态的，不需要特殊初始化）
    _ = utils;
    _ = types;
    _ = errors;
}

/// 清理共享层
///
/// 在应用程序关闭时调用，释放共享层占用的资源。
/// 必须在应用程序退出前调用，以避免内存泄漏。
pub fn deinit() void {
    std.debug.print("👋 共享层已清理\n", .{});
    // 注意：不再在这里调用 global.deinit()
    // global 模块的清理已经移到 root.zig 的 deinitSystem 中统一管理
}
